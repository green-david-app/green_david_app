<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>GreenDavid ‚Äì Intern√≠ syst√©m</title>
    <link rel="stylesheet" href="/style.css"/>
  </head>
  <body>
    <header class="header">
      <div class="brand">
        <img src="/logo.svg" alt="GreenDavid" class="brand-logo" />
        <div>
          <div style="font-weight:700">GreenDavid ‚Äì Intern√≠ syst√©m</div>
          <div class="brand-sub">Zak√°zky ‚Ä¢ Zamƒõstnanci ‚Ä¢ Sklad</div>
        </div>
        <div class="right small" id="userbox"></div>
      </div>
    </header>

    <main class="container">
      <div id="app"></div>
      <div id="js-error" class="error-overlay" style="display:none"></div>
    </main>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone@7.24.4/babel.min.js" crossorigin></script>

    <script>
      // Visible error overlay so "blank screen" se u≈æ nestane
      function showJSError(msg){
        var el = document.getElementById('js-error');
        el.style.display = 'block';
        el.textContent = String(msg || 'Nezn√°m√° chyba ve skriptu.');
      }
      window.addEventListener('error', function(e){ showJSError(e.error ? (e.error.stack||e.error) : (e.message||e)); });
      window.addEventListener('unhandledrejection', function(e){ showJSError(e.reason ? (e.reason.stack||e.reason) : e); });
    </script>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo } = React;

      async function api(path, opts={}){
        const res = await fetch(path, {credentials:"same-origin", headers:{"Content-Type":"application/json"}, ...opts});
        if(!res.ok){
          let msg = res.statusText;
          try{ const j = await res.json(); msg = j.error || msg; }catch{}
          throw new Error(msg);
        }
        try{ return await res.json(); }catch{return {};}
      }
      async function refreshUserBox(){
        const box = document.getElementById("userbox");
        try{
          const j = await api("/api/me");
          if(j.authenticated){
            box.innerHTML = `P≈ôihl√°≈°en: <b>${j.user.name}</b> (${j.user.role}) &nbsp; <button class="ghost" id="logout-btn">Odhl√°sit</button>`;
            document.getElementById("logout-btn").onclick = async ()=>{ await api("/api/logout",{method:"POST"}); location.reload(); };
          } else {
            box.innerHTML = '<span>Nep≈ôihl√°≈°en</span>';
          }
        }catch(e){ box.innerText = ""; }
      }

      function Login({onLogged}){
        const [email,setEmail]=useState("");
        const [pass,setPass]=useState("");
        const [err,setErr]=useState("");
        async function submit(e){
          e.preventDefault();
          setErr("");
          try{
            await api("/api/login",{method:"POST", body: JSON.stringify({email, password:pass})});
            onLogged();
          }catch(e){ setErr("≈†patn√Ω e‚Äëmail nebo heslo"); }
        }
        return (
          <div className="card" style={{maxWidth:420, margin:"40px auto"}}>
            <div className="card-h"><div>P≈ôihl√°≈°en√≠</div></div>
            <div className="card-c">
              <form onSubmit={submit}>
                <div className="form-row"><input type="email" placeholder="E‚Äëmail" value={email} onChange={e=>setEmail(e.target.value)} required style={{flex:1}}/></div>
                <div className="form-row"><input type="password" placeholder="Heslo" value={pass} onChange={e=>setPass(e.target.value)} required style={{flex:1}}/></div>
                {err && <div className="small notice">{err}</div>}
                <div className="form-row" style={{justifyContent:"flex-end"}}><button type="submit">P≈ôihl√°sit</button></div>
                <div className="small">V√Ωchoz√≠ admin: <b>admin@greendavid.local</b> / <b>admin123</b>.</div>
              </form>
            </div>
          </div>
        );
      }

      function Tabs({value,onChange,canAdmin}){
        const items=[
          {key:"jobs",label:"Zak√°zky"},
          {key:"employees",label:"Zamƒõstnanci"},
          {key:"warehouse",label:"Sklad"},
          ...(canAdmin?[{key:"users",label:"U≈æivatel√©"}]:[]),
        ];
        return <div className="tabs">{items.map(it=>(
          <div key={it.key} className={"tab"+(it.key===value?" active":"")} onClick={()=>onChange(it.key)}>{it.label}</div>
        ))}</div>;
      }

      function Jobs(){
        const [list,setList]=useState([]);
        const [form,setForm]=useState({title:"",client:"",status:"Pl√°n",city:"",code:"",date:""});
        const [err,setErr]=useState("");
        async function load(){ try{ const j=await api("/api/jobs"); setList(j.jobs||[]); }catch(e){ setErr(e.message); } }
        useEffect(()=>{ load(); },[]);
        async function add(e){ e.preventDefault(); try{ await api("/api/jobs",{method:"POST",body:JSON.stringify(form)}); setForm({title:"",client:"",status:"Pl√°n",city:"",code:"",date:""}); load(); }catch(e){ setErr(e.message);} }
        async function del(id){ if(!confirm("Smazat zak√°zku?")) return; await api("/api/jobs?id="+id,{method:"DELETE"}); load(); }
        async function setStatus(z, next){ await api("/api/jobs",{method:"PATCH",body:JSON.stringify({id:z.id,status:next})}); load(); }
        const pipeline = (s)=>{ const order=["Pl√°n","Prob√≠h√°","Dokonƒçeno"]; const i=order.indexOf(s||"Pl√°n"); return order[(i+1)%order.length]; };
        return (
          <div className="grid" style={{gridTemplateColumns:"1fr"}}>
            <div className="card">
              <div className="card-h"><div>Nov√° zak√°zka</div></div>
              <div className="card-c">
                <form onSubmit={add}>
                  <div className="form-row">
                    <input placeholder="N√°zev" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} style={{flex:2}} required/>
                    <input placeholder="Z√°kazn√≠k" value={form.client} onChange={e=>setForm({...form,client:e.target.value})} style={{flex:2}} required/>
                    <select value={form.status} onChange={e=>setForm({...form,status:e.target.value})}>
                      <option>Pl√°n</option><option>Prob√≠h√°</option><option>Dokonƒçeno</option>
                    </select>
                  </div>
                  <div className="form-row">
                    <input placeholder="Mƒõsto" value={form.city} onChange={e=>setForm({...form,city:e.target.value})} required/>
                    <input placeholder="K√≥d (nap≈ô. 2025-091)" value={form.code} onChange={e=>setForm({...form,code:e.target.value})} required/>
                    <input type="date" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} required/>
                    <button type="submit">P≈ôidat</button>
                  </div>
                </form>
                {err && <div className="small notice">{err}</div>}
              </div>
            </div>

            {list.map(z=> (
              <div className="card" key={z.id}>
                <div className="card-h">
                  <div>
                    <div style={{fontWeight:600}}>{z.title}</div>
                    <div className="small">{z.client} ‚Ä¢ {z.city} ‚Ä¢ {z.code}</div>
                  </div>
                  <span className="badge">{z.status}</span>
                </div>
                <div className="card-c">
                  <div className="kv small"><span>üìÖ</span> <span>{z.date}</span></div>
                  <div style={{marginTop:12, display:"flex", gap:8}}>
                    <button onClick={()=> setStatus(z, pipeline(z.status))}>Posunout stav</button>
                    <button className="ghost" onClick={()=> del(z.id)}>Smazat</button>
                  </div>
                </div>
              </div>
            ))}
            {list.length===0 && <div className="empty card"><div className="card-c">Zat√≠m ≈æ√°dn√© zak√°zky ‚Äì p≈ôidej prvn√≠ v√Ω≈°e.</div></div>}
          </div>
        );
      }

      function Employees(){
        const [list,setList]=useState([]);
        const [form,setForm]=useState({name:"",role:"Zahradn√≠k"});
        const [err,setErr]=useState("");
        async function load(){ try{ const j=await api("/api/employees"); setList(j.employees||[]); }catch(e){ setErr(e.message); } }
        useEffect(()=>{ load(); },[]);
        async function add(e){ e.preventDefault(); await api("/api/employees",{method:"POST",body:JSON.stringify(form)}); setForm({name:"",role:"Zahradn√≠k"}); load(); }
        async function del(id){ if(!confirm("Smazat zamƒõstnance?")) return; await api("/api/employees?id="+id,{method:"DELETE"}); load(); }
        return (
          <div className="grid" style={{gridTemplateColumns:"1fr"}}>
            <div className="card">
              <div className="card-h"><div>Nov√Ω zamƒõstnanec</div></div>
              <div className="card-c">
                <form onSubmit={add}>
                  <div className="form-row">
                    <input placeholder="Jm√©no" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required style={{flex:1}}/>
                    <input placeholder="Role (nap≈ô. Zahradn√≠k)" value={form.role} onChange={e=>setForm({...form,role:e.target.value})} required style={{flex:1}}/>
                    <button type="submit">P≈ôidat</button>
                  </div>
                </form>
                {err && <div className="small notice">{err}</div>}
              </div>
            </div>
            <div className="card">
              <div className="card-h"><div>Seznam</div></div>
              <div className="card-c">
                <table className="table">
                  <thead><tr><th>ID</th><th>Jm√©no</th><th>Role</th><th></th></tr></thead>
                  <tbody>
                    {list.map(e=>(
                      <tr key={e.id}>
                        <td>{e.id}</td><td>{e.name}</td><td>{e.role}</td>
                        <td><button className="ghost" onClick={()=>del(e.id)}>Smazat</button></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
            {list.length===0 && <div className="empty card"><div className="card-c">Zat√≠m ≈æ√°dn√≠ zamƒõstnanci ‚Äì p≈ôidej prvn√≠ho v√Ω≈°e.</div></div>}
          </div>
        );
      }

      function Warehouse(){
        const [site,setSite]=useState("lipnik");
        const [list,setList]=useState([]);
        const [form,setForm]=useState({category:"",name:"",qty:0,unit:"ks"});
        const [q,setQ]=useState("");
        const [err,setErr]=useState("");
        async function load(){ try{ const j=await api("/api/items?site="+site); setList(j.items||[]); }catch(e){ setErr(e.message); } }
        useEffect(()=>{ load(); },[site]);
        async function add(e){ e.preventDefault(); await api("/api/items",{method:"POST",body:JSON.stringify({...form,site})}); setForm({category:"",name:"",qty:0,unit:"ks"}); load(); }
        async function del(id){ if(!confirm("Smazat polo≈æku?")) return; await api("/api/items?id="+id,{method:"DELETE"}); load(); }
        const filtered = useMemo(()=> list.filter(r=> (r.name||"").toLowerCase().includes(q.toLowerCase())), [list,q]);
        return (
          <div>
            <div style={{display:"flex",gap:8,alignItems:"center",margin:"8px 0 12px"}}>
              <div className="tabs">
                <div className={"tab"+(site==="lipnik"?" active":"")} onClick={()=>setSite("lipnik")}>Lipn√≠k</div>
                <div className={"tab"+(site==="praha"?" active":"")} onClick={()=>setSite("praha")}>Praha</div>
              </div>
              <div className="search" style={{flex:1}}>
                <input value={q} onChange={e=> setQ(e.target.value)} placeholder="Hledat polo≈æku‚Ä¶"/>
                <button className="ghost">Hledat</button>
              </div>
            </div>

            <div className="card">
              <div className="card-h"><div>Nov√° polo≈æka</div></div>
              <div className="card-c">
                <form onSubmit={add}>
                  <div className="form-row">
                    <input placeholder="Kategorie" value={form.category} onChange={e=>setForm({...form,category:e.target.value})} required/>
                    <input placeholder="N√°zev" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required style={{flex:2}}/>
                    <input type="number" step="0.01" placeholder="Mno≈æstv√≠" value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})} required style={{width:120}}/>
                    <input placeholder="Jedn." value={form.unit} onChange={e=>setForm({...form,unit:e.target.value})} required style={{width:80}}/>
                    <button type="submit">P≈ôidat</button>
                  </div>
                </form>
                {err && <div className="small notice">{err}</div>}
              </div>
            </div>

            <div className="card">
              <div className="card-h"><div>Invent√°≈ô ‚Äì {site==="lipnik"?"Lipn√≠k":"Praha"}</div></div>
              <div className="card-c">
                <div className="row h"><div style={{gridColumn:"span 4"}}>Kategorie</div><div style={{gridColumn:"span 6"}}>N√°zev</div><div style={{gridColumn:"span 1",textAlign:"right"}}>Mno≈æstv√≠</div><div style={{gridColumn:"span 1",textAlign:"right"}}>Jedn.</div></div>
                {filtered.length===0 && <div className="empty">Pr√°zdn√© ‚Äì p≈ôidej polo≈æky v√Ω≈°e.</div>}
                {filtered.map(r=> (
                  <div className="row small" key={r.id}>
                    <div style={{gridColumn:"span 4"}}>{r.category}</div>
                    <div style={{gridColumn:"span 6"}}>{r.name}</div>
                    <div style={{gridColumn:"span 1",textAlign:"right"}}>{r.qty}</div>
                    <div style={{gridColumn:"span 1",textAlign:"right"}}>{r.unit}</div>
                    <div style={{gridColumn:"span 12",textAlign:"right"}}><button className="ghost" onClick={()=>del(r.id)}>Smazat</button></div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      function UsersTab(){
        const [list,setList]=useState([]);
        const [form,setForm]=useState({email:"",name:"",role:"worker",password:""});
        const [err,setErr]=useState("");
        async function load(){ try{ const j=await api("/api/users"); setList(j.users||[]); }catch(e){ setErr(e.message);} }
        useEffect(()=>{load()},[]);
        async function create(e){ e.preventDefault(); await api("/api/users",{method:"POST",body:JSON.stringify(form)}); setForm({email:"",name:"",role:"worker",password:""}); load(); }
        async function setRole(id,role){ await api("/api/users",{method:"PATCH",body:JSON.stringify({id,role})}); load(); }
        async function toggleActive(u){ await api("/api/users",{method:"PATCH",body:JSON.stringify({id:u.id,active:!u.active})}); load(); }
        return (
          <div className="grid" style={{gridTemplateColumns:"1fr"}}>
            <div className="card">
              <div className="card-h"><div>Nov√Ω u≈æivatel</div></div>
              <div className="card-c">
                <form onSubmit={create}>
                  <div className="form-row">
                    <input placeholder="E‚Äëmail" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} required style={{flex:1}}/>
                    <input placeholder="Jm√©no" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required style={{flex:1}}/>
                  </div>
                  <div className="form-row">
                    <select value={form.role} onChange={e=>setForm({...form,role:e.target.value})}>
                      <option value="worker">worker</option>
                      <option value="manager">manager</option>
                      <option value="admin">admin</option>
                    </select>
                    <input type="password" placeholder="Heslo" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} required/>
                    <button type="submit">Vytvo≈ôit</button>
                  </div>
                </form>
                {err && <div className="small notice">{err}</div>}
              </div>
            </div>
            <div className="card">
              <div className="card-h"><div>U≈æivatel√©</div></div>
              <div className="card-c">
                <table className="table">
                  <thead><tr><th>ID</th><th>E‚Äëmail</th><th>Jm√©no</th><th>Role</th><th>Aktivn√≠</th><th></th></tr></thead>
                  <tbody>
                    {list.map(u=>(
                      <tr key={u.id}>
                        <td>{u.id}</td><td>{u.email}</td><td>{u.name}</td><td>{u.role}</td><td>{u.active? "ano":"ne"}</td>
                        <td className="small">
                          <button className="ghost" onClick={()=>setRole(u.id,"worker")}>worker</button>
                          <button className="ghost" onClick={()=>setRole(u.id,"manager")}>manager</button>
                          <button className="ghost" onClick={()=>setRole(u.id,"admin")}>admin</button>
                          <button className="ghost" onClick={()=>toggleActive(u)}>{u.active?"deaktivovat":"aktivovat"}</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        );
      }

      function App(){
        const [auth,setAuth]=useState({ready:false, ok:false, user:null});
        const [tab, setTab] = useState("jobs");
        useEffect(()=>{(async()=>{ try{ const j=await api("/api/me"); setAuth({ready:true, ok:j.authenticated, user:j.user||null}); refreshUserBox(); }catch(e){ showJSError(e.message);} })()},[]);
        if(!auth.ready) return <div className="small">Naƒç√≠t√°m‚Ä¶</div>;
        if(!auth.ok) return <Login onLogged={()=>location.reload()}/>;
        const isAdmin = auth.user?.role==="admin";
        return (
          <div>
            <Tabs value={tab} onChange={setTab} canAdmin={isAdmin}/>
            <div style={{height:12}}/>
            {tab==="jobs" && <Jobs/>}
            {tab==="employees" && <Employees/>}
            {tab==="warehouse" && <Warehouse/>}
            {tab==="users" && isAdmin && <UsersTab/>}
            <p className="small" style={{marginTop:14}}>¬© {new Date().getFullYear()} GreenDavid</p>
          </div>
        );
      }

      try{
        ReactDOM.createRoot(document.getElementById("app")).render(<App/>);
      }catch(e){ showJSError(e.stack||e); }
    </script>
  </body>
</html>
