<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>GreenDavid ‚Äì Intern√≠ syst√©m</title>
    <link rel="stylesheet" href="/style.css"/>
  </head>
  <body>
    <header class="header">
      <div class="brand">
        <div class="brand-logo">GD</div>
        <div>
          <div style="font-weight:700">GreenDavid ‚Äì Intern√≠ syst√©m</div>
          <div class="brand-sub">Zak√°zky ‚Ä¢ Zamƒõstnanci ‚Ä¢ Sklad ‚Ä¢ Fotky</div>
        </div>
        <div class="right small" id="userbox"></div>
      </div>
    </header>

    <main class="container">
      <noscript style="color:#fca5a5">Pro spu≈°tƒõn√≠ aplikace je pot≈ôeba JavaScript.</noscript>
      <div id="app"></div>
      <p class="small">¬© <span id="year"></span> GreenDavid. Tmav√© UI, vysok√Ω kontrast, bez zelen√©ho p√≠sma.</p>
    </main>

    <!-- React & Babel (fixed versions) -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone@7.24.4/babel.min.js" crossorigin></script>

    <!-- App script transformed by Babel in the browser -->
    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo } = React;

      async function api(path, opts={}){
        const res = await fetch(path, {credentials:"same-origin", headers:{"Content-Type":"application/json"}, ...opts});
        return res.json();
      }

      async function refreshUserBox(){
        const box = document.getElementById("userbox");
        try{
          const j = await api("/api/me");
          if(j.authenticated){
            box.innerHTML = \`P≈ôihl√°≈°en: <b>\${j.user.name}</b> (\${j.user.role}) &nbsp; <button class="ghost" id="logout-btn">Odhl√°sit</button>\`;
            document.getElementById("logout-btn").onclick = async ()=>{ await api("/api/logout",{method:"POST"}); location.reload(); };
          } else {
            box.innerHTML = '<span>Nep≈ôihl√°≈°en</span>';
          }
        }catch(e){ box.innerText = ""; }
      }

      function Login({onLogged}){
        const [email,setEmail]=useState("");
        const [pass,setPass]=useState("");
        const [err,setErr]=useState("");
        async function submit(e){
          e.preventDefault();
          setErr("");
          const j = await api("/api/login",{method:"POST", body: JSON.stringify({email, password:pass})});
          if(j.ok){ onLogged(); } else { setErr("≈†patn√Ω e‚Äëmail nebo heslo"); }
        }
        return (
          <div className="card" style={{maxWidth:420, margin:"40px auto"}}>
            <div className="card-h"><div>P≈ôihl√°≈°en√≠</div></div>
            <div className="card-c">
              <form onSubmit={submit}>
                <div className="form-row"><input type="email" placeholder="E‚Äëmail" value={email} onChange={e=>setEmail(e.target.value)} required style={{flex:1}}/></div>
                <div className="form-row"><input type="password" placeholder="Heslo" value={pass} onChange={e=>setPass(e.target.value)} required style={{flex:1}}/></div>
                {err && <div className="small notice">{err}</div>}
                <div className="form-row" style={{justifyContent:"flex-end"}}><button type="submit">P≈ôihl√°sit</button></div>
                <div className="small">V√Ωchoz√≠ administr√°tor: <b>admin@greendavid.local</b> / <b>admin123</b> (zmƒõ≈à po p≈ôihl√°≈°en√≠).</div>
              </form>
            </div>
          </div>
        );
      }

      const EMPLOYEES=[
        { id: "e1", name: "Jan Nov√°k", role: "Zahradn√≠k" },
        { id: "e2", name: "Pavla Svobodov√°", role: "Vedouc√≠ t√Ωmu" },
        { id: "e3", name: "Filip Hor√°k", role: "Technik z√°vlah" },
      ];
      const JOBS=[
        { id: "z1", title: "√ödr≈æba parku ‚Äì Kunice", client: "Obec Kunice", status: "Prob√≠h√°", city: "Kunice", code: "2025-091", date: "2025-10-03" },
        { id: "z2", title: "V√Ωsadba sadu ‚Äì Lipn√≠k", client: "Soukrom√Ω investor", status: "Pl√°n", city: "Lipn√≠k", code: "2025-087", date: "2025-10-06" },
        { id: "z3", title: "Instalace z√°vlah ‚Äì Praha 6", client: "SVJ Bƒõlohorsk√°", status: "Dokonƒçeno", city: "Praha", code: "2025-072", date: "2025-09-25" },
      ];
      const WAREHOUSE={
        lipnik: {"Rostliny / Trvalky":[{id:"p1",name:"Nepeta 'Walker's Low'",qty:120,unit:"ks"},{id:"p2",name:"Heuchera mix",qty:80,unit:"ks"}],
                 "Rostliny / Tr√°vy":[{id:"p3",name:"Calamagrostis 'Karl Foerster'",qty:60,unit:"ks"}],
                 "Rostliny / Ke≈ôe":[{id:"p4",name:"Buxus sempervirens",qty:45,unit:"ks"}],
                 "Rostliny / Stromy":[{id:"p5",name:"Pyrus 'Lucasova' 10-12",qty:12,unit:"ks"}],
                 "Rostliny / Cibuloviny":[{id:"p6",name:"Tulipa 'Queen of Night'",qty:500,unit:"ks"}],
                 "Hnojiva/Post≈ôiky":[{id:"h1",name:"Kristalon Gold 25 kg",qty:6,unit:"ks"},{id:"h2",name:"Roundup Klasik 5 l",qty:2,unit:"ks"}],
                 "Materi√°l zahrada":[{id:"mz1",name:"Textilie 90g 1,6√ó100 m",qty:5,unit:"role"}],
                 "Materi√°l stavba":[{id:"ms1",name:"≈†tƒõrk fr. 4-8",qty:18,unit:"t"}],
                 "N√°≈ôad√≠":[{id:"n1",name:"Motorov√° pila Stihl MS 261",qty:2,unit:"ks"}]},
        praha:  {"Rostliny / Trvalky":[{id:"pp1",name:"Salvia nemorosa 'Caradonna'",qty:90,unit:"ks"}]}
      };

      function UsersTab(){
        const [list,setList]=React.useState([]);
        const [form,setForm]=React.useState({email:"",name:"",role:"worker",password:""});
        async function load(){ const j=await api("/api/users"); if(j.ok) setList(j.users); }
        React.useEffect(()=>{load()},[]);
        async function create(e){ e.preventDefault(); const j=await api("/api/users",{method:"POST",body:JSON.stringify(form)}); if(j.ok){ setForm({email:"",name:"",role:"worker",password:""}); load(); } }
        async function setRole(id,role){ await api("/api/users",{method:"PATCH",body:JSON.stringify({id,role})}); load(); }
        async function toggleActive(u){ await api("/api/users",{method:"PATCH",body:JSON.stringify({id:u.id,active:!u.active})}); load(); }
        return (
          <div className="grid" style={{gridTemplateColumns:"1fr"}}>
            <div className="card">
              <div className="card-h"><div>Nov√Ω u≈æivatel</div></div>
              <div className="card-c">
                <form onSubmit={create}>
                  <div className="form-row"><input placeholder="E‚Äëmail" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} required style={{flex:1}}/></div>
                  <div className="form-row"><input placeholder="Jm√©no" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} required style={{flex:1}}/></div>
                  <div className="form-row">
                    <select value={form.role} onChange={e=>setForm({...form,role:e.target.value})}>
                      <option value="worker">worker</option>
                      <option value="manager">manager</option>
                      <option value="admin">admin</option>
                    </select>
                    <input type="password" placeholder="Heslo" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} required/>
                    <button type="submit">Vytvo≈ôit</button>
                  </div>
                </form>
              </div>
            </div>

            <div className="card">
              <div className="card-h"><div>U≈æivatel√©</div></div>
              <div className="card-c">
                <table className="table">
                  <thead><tr><th>ID</th><th>E‚Äëmail</th><th>Jm√©no</th><th>Role</th><th>Aktivn√≠</th><th></th></tr></thead>
                  <tbody>
                    {list.map(u=>(
                      <tr key={u.id}>
                        <td>{u.id}</td><td>{u.email}</td><td>{u.name}</td><td>{u.role}</td><td>{u.active? "ano":"ne"}</td>
                        <td className="small">
                          <button className="ghost" onClick={()=>setRole(u.id,"worker")}>worker</button>
                          <button className="ghost" onClick={()=>setRole(u.id,"manager")}>manager</button>
                          <button className="ghost" onClick={()=>setRole(u.id,"admin")}>admin</button>
                          <button className="ghost" onClick={()=>toggleActive(u)}>{u.active?"deaktivovat":"aktivovat"}</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        );
      }

      function Jobs(){ /* same as v11 */ 
        const [open, setOpen] = React.useState(null);
        const [stage, setStage] = React.useState({});
        const pipeline = (s)=>{ const order=["Pl√°n","Prob√≠h√°","Dokonƒçeno"]; const i=order.indexOf(s||"Pl√°n"); return order[(i+1)%order.length]; };
        function compress(e,maxSide=1200,quality=0.8, id){
          const file = e.target.files?.[0]; if(!file) return;
          const img = new Image();
          const reader = new FileReader();
          reader.onload = () => { img.src = reader.result; };
          reader.readAsDataURL(file);
          img.onload = () => {
            const scale = (img.width>img.height) ? maxSide/img.width : maxSide/img.height;
            const w = Math.round(img.width*scale);
            const h = Math.round(img.height*scale);
            const c = document.createElement("canvas");
            c.width = w; c.height = h;
            const ctx = c.getContext("2d");
            ctx.drawImage(img,0,0,w,h);
            const url = c.toDataURL("image/jpeg", quality);
            const preview = document.getElementById("preview-"+id);
            preview.innerHTML = "";
            const im = document.createElement("img");
            im.src = url; im.className="img-preview";
            preview.appendChild(im);
          };
        }
        function exportSection(){ window.print(); }
        return (
          <div className="grid" style={{gridTemplateColumns:"1fr 1fr"}}>
            {JOBS.map(z=> (
              <div className="card" key={z.id}>
                <div className="card-h">
                  <div>
                    <div style={{fontWeight:600}}>{z.title}</div>
                    <div className="small">{z.client} ‚Ä¢ {z.city} ‚Ä¢ {z.code}</div>
                  </div>
                  <span className="badge">{stage[z.id]||z.status}</span>
                </div>
                <div className="card-c">
                  <div className="kv small"><span>üìÖ</span> <span>{z.date}</span></div>
                  <hr/>
                  <button className="ghost" onClick={()=> setOpen(open===z.id? null : z.id)}>
                    {open===z.id? "Skr√Ωt detail" : "Zobrazit detail"}
                  </button>
                  {open===z.id && (
                    <div style={{marginTop:12}}>
                      <div className="card" style={{marginBottom:12}}>
                        <div className="card-h"><div>Materi√°l</div><button>P≈ôidat polo≈æku</button></div>
                        <div className="card-c small">
                          <div className="row h"><div style={{gridColumn:"span 6"}}>N√°zev</div><div style={{gridColumn:"span 3",textAlign:"right"}}>Mno≈æstv√≠</div><div style={{gridColumn:"span 2"}}>Jedn.</div><div style={{gridColumn:"span 1",textAlign:"right"}}>Akce</div></div>
                          <div className="row"><div style={{gridColumn:"span 6"}}>Mulƒçovac√≠ k≈Øra 70 l</div><div style={{gridColumn:"span 3",textAlign:"right"}}>30</div><div style={{gridColumn:"span 2"}}>ks</div><div style={{gridColumn:"span 1",textAlign:"right"}}>‚Äî</div></div>
                          <div className="row"><div style={{gridColumn:"span 6"}}>PE hadice 16 mm</div><div style={{gridColumn:"span 3",textAlign:"right"}}>120</div><div style={{gridColumn:"span 2"}}>m</div><div style={{gridColumn:"span 1",textAlign:"right"}}>‚Äî</div></div>
                        </div>
                      </div>
                      <div className="card" style={{marginBottom:12}}>
                        <div className="card-h"><div>N√°≈ôad√≠</div><button>P≈ôidat polo≈æku</button></div>
                        <div className="card-c small">
                          <div className="row"><div style={{gridColumn:"span 9"}}>Vibraƒçn√≠ deska 100 kg</div><div style={{gridColumn:"span 3",textAlign:"right"}}>1 ks</div></div>
                          <div className="row"><div style={{gridColumn:"span 9"}}>Vrtac√≠ kladivo SDS‚ÄëMax</div><div style={{gridColumn:"span 3",textAlign:"right"}}>1 ks</div></div>
                        </div>
                      </div>
                      <div className="card">
                        <div className="card-h"><div>Fotodokumentace</div></div>
                        <div className="card-c">
                          <p className="small">Nahran√© fotky se automaticky zmen≈°√≠ na max. 1200 px (JPEG) pro rychl√© naƒç√≠t√°n√≠.</p>
                          <label><input id={"file-"+z.id} type="file" accept="image/*" onChange={(e)=>compress(e,1200,0.8,z.id)}/><button className="ghost">Nahr√°t fotku</button></label>
                          <div id={"preview-"+z.id} style={{marginTop:12}}></div>
                        </div>
                      </div>
                    </div>
                  )}
                  <div style={{marginTop:12, display:"flex", gap:8}}>
                    <button onClick={()=> setStage(s=>({...s,[z.id]: pipeline(s[z.id]||z.status)}))}>Posunout stav</button>
                    <button className="ghost" onClick={exportSection}>Export PDF n√°hledu</button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        );
      }

      function Employees(){ /* same as v11 */ 
        const [q, setQ] = React.useState("");
        const [open, setOpen] = React.useState(null);
        const filtered = React.useMemo(()=> EMPLOYEES.filter(e=> (e.name.toLowerCase().includes(q.toLowerCase()))), [q]);
        const times = {
          e1:[{date:"2025-10-01",hours:8,job:"√ödr≈æba parku ‚Äì Kunice"},{date:"2025-10-02",hours:6,job:"Instalace z√°vlah ‚Äì Praha 6"}],
          e2:[{date:"2025-10-02",hours:9,job:"V√Ωsadba sadu ‚Äì Lipn√≠k"}],
          e3:[{date:"2025-10-03",hours:7.5,job:"Instalace z√°vlah ‚Äì Praha 6"}],
        };
        return (
          <div>
            <div className="search" style={{margin:"8px 0 12px"}}>
              <input value={q} onChange={e=> setQ(e.target.value)} placeholder="Hledat jm√©no‚Ä¶"/>
              <button className="ghost">Hledat</button>
            </div>
            <div className="grid" style={{gridTemplateColumns:"repeat(3,1fr)"}}>
              {filtered.map(e=> (
                <div className="card" key={e.id}>
                  <div className="card-h">
                    <div style={{fontWeight:600}}>{e.name}</div>
                    <span className="badge">{e.role}</span>
                  </div>
                  <div className="card-c">
                    <div className="small mono">ID: {e.id.toUpperCase()}</div>
                    <button className="ghost" style={{marginTop:8}} onClick={()=> setOpen(open===e.id? null : e.id)}>
                      {open===e.id? "Skr√Ωt v√Ωkazy" : "Zobrazit v√Ωkazy"}
                    </button>
                    {open===e.id and (
                      <div style={{marginTop:12}}>
                        <div className="row h"><div style={{gridColumn:"span 4"}}>Den</div><div style={{gridColumn:"span 2",textAlign:"right"}}>Hod</div><div style={{gridColumn:"span 6"}}>Zak√°zka</div></div>
                        {(times[e.id]||[]).map((r,i)=> (
                          <div className="row small" key={i}><div style={{gridColumn:"span 4"}}>{r.date}</div><div style={{gridColumn:"span 2",textAlign:"right"}}>{r.hours}</div><div style={{gridColumn:"span 6"}}>{r.job}</div></div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      }

      function Settings(){
        return (
          <div className="card">
            <div className="card-c">
              <div className="row small"><div style={{gridColumn:"span 12"}}><b>Vzhled:</b> vysok√Ω kontrast, tmav√© pozad√≠, svƒõtl√© p√≠smo. ≈Ω√°dn√© zelen√© p√≠smo.</div></div>
              <div className="row small"><div style={{gridColumn:"span 12"}}><b>Export:</b> ‚ÄûExport PDF n√°hledu‚Äú otev≈ôe tiskov√Ω dialog (ulo≈æ√≠≈° jako PDF).</div></div>
            </div>
          </div>
        );
      }

      function App(){
        const [auth,setAuth]=React.useState({ready:false, ok:false, user:null});
        const [tab, setTab] = React.useState("jobs");
        React.useEffect(()=>{(async()=>{ const j=await api("/api/me"); setAuth({ready:true, ok:j.authenticated, user:j.user||null}); refreshUserBox(); console.log("App mounted"); })()},[]);
        if(!auth.ready) return <div className="small">Naƒç√≠t√°m‚Ä¶</div>;
        if(!auth.ok) return <Login onLogged={()=>location.reload()}/>;
        const canAdmin = auth.user?.role==="admin";
        return (
          <div>
            <div className="tabs">
              <div className={"tab"+(tab==="jobs"?" active":"")} onClick={()=>setTab("jobs")}>Zak√°zky</div>
              <div className={"tab"+(tab==="employees"?" active":"")} onClick={()=>setTab("employees")}>Zamƒõstnanci</div>
              <div className={"tab"+(tab==="warehouse"?" active":"")} onClick={()=>setTab("warehouse")}>Sklad</div>
              {canAdmin && <div className={"tab"+(tab==="users"?" active":"")} onClick={()=>setTab("users")}>U≈æivatel√©</div>}
              <div className={"tab"+(tab==="settings"?" active":"")} onClick={()=>setTab("settings")}>Nastaven√≠</div>
            </div>
            <div style={{height:12}}/>
            {tab==="jobs" && <Jobs/>}
            {tab==="employees" && <Employees/>}
            {tab==="warehouse" && <Warehouse/>}
            {tab==="users" && canAdmin && <UsersTab/>}
            {tab==="settings" && <Settings/>}
          </div>
        );
      }

      try{
        ReactDOM.createRoot(document.getElementById("app")).render(<App/>);
        document.getElementById("year").textContent = new Date().getFullYear();
      } catch(e){
        const a = document.getElementById("app");
        a.innerHTML = '<div class="small" style="color:#fca5a5">Chyba p≈ôi startu aplikace. Zkuste obnovit str√°nku.</div>';
        console.error(e);
      }
    </script>
  </body>
</html>
